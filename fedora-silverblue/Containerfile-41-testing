FROM localhost/fedora-silverblue:41

# - Remove ostree-grub2, setup composefs, rebuild initramfs
# - Install bootupd and generate metadata
#RUN rpm-ostree --assumeyes override remove ostree-grub2 && \
RUN dnf --assumeyes remove ostree-grub2 && \
    echo -e "[composefs]\nenabled=yes" >> /usr/lib/ostree/prepare-root.conf && \
    export KERNEL_VERSION="$(rpm --query --all kernel --queryformat '%{VERSION}-%{RELEASE}.%{ARCH}')" && \
    stock_arguments=$(lsinitrd "/lib/modules/${KERNEL_VERSION}/initramfs.img" | grep '^Arguments: ' | sed 's/^Arguments: //') && \
    mkdir --parents /tmp/dracut /var/roothome && \
#    mkdir --parents /tmp/dracut /var/roothome /usr/lib/ostree-boot/efi/EFI && \
    bash <(/usr/bin/echo "dracut $stock_arguments") && \
    rm --recursive --force /var/* /tmp/*  && \
    mv --verbose /boot/initramfs*.img "/lib/modules/${KERNEL_VERSION}/initramfs.img" #\
#    && \
#    /usr/bin/bootupctl backend generate-update-metadata \
#    && \
#    rpm-ostree cleanup --repomd
